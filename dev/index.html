<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onpa - Èü≥Ê•Ω„Ç∑„Çß„Ç¢ÈÄöË©±„Ç¢„Éó„É™</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: #fff;
        }

        .container {
            max-width: 430px;
            margin: 0 auto;
            padding: 20px;
        }

        .logo {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #ff3366, #0096ff, #00ffc8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .platform-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .platform-btn {
            flex: 1;
            padding: 12px 8px;
            border-radius: 12px;
            border: 2px solid #333;
            background: #111;
            color: #888;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .platform-btn.active {
            border-color: #1DB954;
            background: #1DB95422;
            color: #1DB954;
        }

        .platform-btn.spotify.active {
            border-color: #1DB954;
            background: #1DB95422;
            color: #1DB954;
        }

        .platform-btn.soundcloud.active {
            border-color: #ff5500;
            background: #ff550022;
            color: #ff5500;
        }

        .platform-btn.youtube.active {
            border-color: #ff0000;
            background: #ff000022;
            color: #ff0000;
        }

        .platform-btn.nina.active {
            border-color: #00ffc8;
            background: #00ffc822;
            color: #00ffc8;
        }

        .spotify-login {
            background: #1DB954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            display: none;
        }

        .spotify-login.show {
            display: block;
        }

        .search-bar {
            width: 100%;
            padding: 14px;
            border-radius: 25px;
            border: 1px solid #333;
            background: #222;
            color: white;
            margin-bottom: 15px;
        }

        .search-result-item {
            background: #222;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .result-artwork {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
        }

        .result-info {
            flex: 1;
            min-width: 0;
        }

        .result-track {
            font-weight: 600;
            margin-bottom: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .result-artist {
            font-size: 12px;
            color: #888;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .result-play-btn {
            background: #1DB954;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .status {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .device-info {
            background: #222;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">Onpa</div>

        <!-- „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†ÈÅ∏Êäû -->
        <div class="platform-selector">
            <button class="platform-btn spotify active" onclick="selectPlatform('spotify')">
                Spotify
            </button>
            <button class="platform-btn soundcloud" onclick="selectPlatform('soundcloud')">
                SoundCloud
            </button>
            <button class="platform-btn youtube" onclick="selectPlatform('youtube')">
                YouTube
            </button>
            <button class="platform-btn nina" onclick="selectPlatform('nina')">
                Nina
            </button>
        </div>

        <!-- Spotify„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥ÔºàSpotify„ÅÆ„ÅøË°®Á§∫Ôºâ -->
        <button class="spotify-login show" id="loginBtn">
            üéµ Spotify„Åß„É≠„Ç∞„Ç§„É≥
        </button>

        <div id="status"></div>

        <!-- Ê§úÁ¥¢„Ç®„É™„Ç¢ -->
        <div id="player">
            <div class="device-info" id="deviceInfo" style="display: none;">„Éá„Éê„Ç§„Çπ: Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            
            <input 
                type="text" 
                id="searchInput" 
                class="search-bar" 
                placeholder="üîç Êõ≤„ÇíÊ§úÁ¥¢..."
                onkeypress="if(event.key==='Enter') search()"
            >
            <div id="results"></div>
        </div>
    </div>

    <script>
        // ========================================
        // üîë APIË®≠ÂÆö
        // ========================================
        const API_KEYS = {
            spotify: {
                clientId: '1ff4e8ebb2f94fb5a20149d697df21fc',
                redirectUri: 'https://on-pa.net/dev/'
            },
            soundcloud: {
                clientId: 'nJJvQWHJTAzFljrCtmXSU03y7JVZPxXA'
            },
            youtube: {
                apiKey: 'AIzaSyCO0ZnLZAugZDAu39pj0z7JaNJ43zdBJRI'
            }
        };
        // ========================================

        let currentPlatform = 'spotify';
        let spotifyToken = null;
        let spotifyDeviceId = null;
        let currentAudio = null;

        console.log("üéµ OnpaËµ∑Âãï");

        // „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†ÈÅ∏Êäû
        function selectPlatform(platform) {
            currentPlatform = platform;
            
            // „Éú„Çø„É≥„ÅÆË¶ã„ÅüÁõÆ„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.platform-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.platform-btn.${platform}`).classList.add('active');
            
            // Spotify„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫
            const loginBtn = document.getElementById('loginBtn');
            const deviceInfo = document.getElementById('deviceInfo');
            
            if (platform === 'spotify') {
                loginBtn.classList.add('show');
                if (spotifyToken) {
                    deviceInfo.style.display = 'block';
                }
            } else {
                loginBtn.classList.remove('show');
                deviceInfo.style.display = 'none';
            }
            
            // Ê§úÁ¥¢Ê¨Ñ„ÅÆ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÂ§âÊõ¥
            const searchInput = document.getElementById('searchInput');
            const placeholders = {
                spotify: 'üîç SpotifyÊ§úÁ¥¢...',
                soundcloud: 'üîç SoundCloudÊ§úÁ¥¢...',
                youtube: 'üîç YouTubeÊ§úÁ¥¢...',
                nina: 'üîç Nina ProtocolÊ§úÁ¥¢...'
            };
            searchInput.placeholder = placeholders[platform];
            
            // ÁµêÊûú„Çí„ÇØ„É™„Ç¢
            document.getElementById('results').innerHTML = '';
            
            console.log('üì± „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†Â§âÊõ¥:', platform);
        }

        // Spotify„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥
        document.getElementById('loginBtn').addEventListener('click', function() {
            console.log("üîµ Spotify„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„Åæ„Åó„Åü");
            const scopes = 'user-read-playback-state user-modify-playback-state streaming user-read-private user-read-email';
            
            const url = `https://accounts.spotify.com/authorize?client_id=${API_KEYS.spotify.clientId}&response_type=token&redirect_uri=${encodeURIComponent(API_KEYS.spotify.redirectUri)}&scope=${encodeURIComponent(scopes)}&show_dialog=true`;
            
            console.log("üåê ÈÄÅ‰ø°URL: ", url);
            window.location.href = url;
        });

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇÔºàSpotifyË™çË®ºÂæåÔºâ
        window.onload = () => {
            console.log("üìÑ „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü");
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            spotifyToken = params.get('access_token');

            if (spotifyToken) {
                console.log("‚úÖ Spotify„Éà„Éº„ÇØ„É≥ÂèñÂæóÊàêÂäüÔºÅ");
                window.history.replaceState({}, '', window.location.pathname);
                document.getElementById('loginBtn').textContent = '‚úì Spotify „É≠„Ç∞„Ç§„É≥Ê∏à„Åø';
                document.getElementById('loginBtn').disabled = true;
                document.getElementById('deviceInfo').style.display = 'block';
                showStatus('‚úÖ Spotify„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü', '#1DB954');
                getSpotifyDevices();
            } else if (params.get('error')) {
                console.error("‚ùå Spotify„Ç®„É©„Éº:", params.get('error'));
                alert("„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº: " + params.get('error'));
            }
        };

        // Spotify„Éá„Éê„Ç§„ÇπÂèñÂæó
        async function getSpotifyDevices() {
            try {
                const res = await fetch('https://api.spotify.com/v1/me/player/devices', {
                    headers: { 'Authorization': `Bearer ${spotifyToken}` }
                });
                const data = await res.json();

                if (data.devices?.length > 0) {
                    const active = data.devices.find(d => d.is_active) || data.devices[0];
                    spotifyDeviceId = active.id;
                    document.getElementById('deviceInfo').textContent = 
                        `„Éá„Éê„Ç§„Çπ: ${active.name} (${active.type})`;
                    console.log('üéß Spotify„Éá„Éê„Ç§„Çπ:', active);
                } else {
                    document.getElementById('deviceInfo').innerHTML = 
                        '‚ö†Ô∏è „Éá„Éê„Ç§„Çπ„Å™„Åó - Spotify„Ç¢„Éó„É™„ÅßÊõ≤„ÇíÂÜçÁîü„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                }
            } catch (e) {
                console.error('‚ùå Device error:', e);
            }
        }

        // Ê§úÁ¥¢Ôºà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†Âà•Ôºâ
        async function search() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;

            console.log(`üîç ${currentPlatform}„ÅßÊ§úÁ¥¢:`, query);
            const results = document.getElementById('results');
            results.innerHTML = '<div class="loading">Ê§úÁ¥¢‰∏≠...</div>';

            try {
                switch(currentPlatform) {
                    case 'spotify':
                        await searchSpotify(query);
                        break;
                    case 'soundcloud':
                        await searchSoundCloud(query);
                        break;
                    case 'youtube':
                        await searchYouTube(query);
                        break;
                    case 'nina':
                        await searchNina(query);
                        break;
                }
            } catch (e) {
                console.error('‚ùå Ê§úÁ¥¢„Ç®„É©„Éº:', e);
                results.innerHTML = '<div class="loading">Ê§úÁ¥¢„Ç®„É©„Éº</div>';
            }
        }

        // SpotifyÊ§úÁ¥¢
        async function searchSpotify(query) {
            if (!spotifyToken) {
                alert('Spotify„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                document.getElementById('results').innerHTML = '';
                return;
            }

            const res = await fetch(
                `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&market=JP&limit=10`,
                { headers: { 'Authorization': `Bearer ${spotifyToken}` } }
            );
            const data = await res.json();
            
            const tracks = data.tracks.items.map(t => ({
                title: t.name,
                artist: t.artists[0].name,
                artwork: t.album.images[0]?.url,
                uri: t.uri,
                platform: 'spotify'
            }));
            
            displayResults(tracks);
        }

        // SoundCloudÊ§úÁ¥¢
        async function searchSoundCloud(query) {
            const res = await fetch(
                `https://api.soundcloud.com/tracks?q=${encodeURIComponent(query)}&client_id=${API_KEYS.soundcloud.clientId}&limit=10`
            );
            const data = await res.json();
            
            const tracks = data.map(t => ({
                title: t.title,
                artist: t.user.username,
                artwork: t.artwork_url || t.user.avatar_url,
                streamUrl: t.stream_url + `?client_id=${API_KEYS.soundcloud.clientId}`,
                platform: 'soundcloud'
            }));
            
            displayResults(tracks);
        }

        // YouTubeÊ§úÁ¥¢
        async function searchYouTube(query) {
            const res = await fetch(
                `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&videoCategoryId=10&maxResults=10&key=${API_KEYS.youtube.apiKey}`
            );
            const data = await res.json();
            
            const tracks = data.items.map(item => ({
                title: item.snippet.title,
                artist: item.snippet.channelTitle,
                artwork: item.snippet.thumbnails.medium.url,
                videoId: item.id.videoId,
                platform: 'youtube'
            }));
            
            displayResults(tracks);
        }

        // Nina ProtocolÊ§úÁ¥¢
        async function searchNina(query) {
            const res = await fetch(
                `https://api.ninaprotocol.com/v1/search?query=${encodeURIComponent(query)}`
            );
            const data = await res.json();
            
            const tracks = (data.releases || []).map(r => ({
                title: r.metadata?.properties?.title || r.title || 'Unknown',
                artist: r.metadata?.properties?.artist || r.artist || 'Unknown',
                artwork: r.metadata?.image || r.image || '',
                audioUrl: r.metadata?.animation_url || r.animation_url || '',
                platform: 'nina'
            }));
            
            displayResults(tracks);
        }

        // ÁµêÊûúË°®Á§∫
        function displayResults(tracks) {
            const div = document.getElementById('results');
            div.innerHTML = '';

            if (!tracks || tracks.length === 0) {
                div.innerHTML = '<div class="loading">ÁµêÊûú„Å™„Åó</div>';
                return;
            }

            tracks.forEach((track, index) => {
                const trackDiv = document.createElement('div');
                trackDiv.className = 'search-result-item';
                trackDiv.innerHTML = `
                    <img src="${track.artwork || ''}" class="result-artwork" onerror="this.style.background='#333'">
                    <div class="result-info">
                        <div class="result-track">${track.title}</div>
                        <div class="result-artist">${track.artist}</div>
                    </div>
                    <button class="result-play-btn" onclick='play(${JSON.stringify(track)})'>‚ñ∂Ô∏è</button>
                `;
                div.appendChild(trackDiv);
            });

            console.log(`‚úÖ ${tracks.length}‰ª∂„ÅÆÁµêÊûú„ÇíË°®Á§∫`);
        }

        // ÂÜçÁîü
        async function play(track) {
            console.log('‚ñ∂Ô∏è ÂÜçÁîü:', track.title, '/', track.platform);

            // Êó¢Â≠ò„ÅÆÈü≥Â£∞„ÇíÂÅúÊ≠¢
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            switch(track.platform) {
                case 'spotify':
                    await playSpotify(track.uri);
                    break;
                case 'soundcloud':
                    playAudio(track.streamUrl);
                    break;
                case 'youtube':
                    alert('YouTubeÂÜçÁîü„ÅØ„Éñ„É©„Ç¶„Ç∂„ÅÆÂà∂Èôê„Å´„Çà„Çä„ÄÅ„É™„É≥„ÇØ„ÇíÈñã„Åç„Åæ„Åô');
                    window.open(`https://www.youtube.com/watch?v=${track.videoId}`, '_blank');
                    break;
                case 'nina':
                    if (track.audioUrl) {
                        playAudio(track.audioUrl);
                    } else {
                        alert('„Åì„ÅÆÊõ≤„ÅØÂÜçÁîüURL„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    }
                    break;
            }
        }

        // SpotifyÂÜçÁîü
        async function playSpotify(uri) {
            if (!spotifyDeviceId) {
                await getSpotifyDevices();
                if (!spotifyDeviceId) {
                    alert('Spotify„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ\n\nSpotify„Ç¢„Éó„É™„ÅßÊõ≤„Çí‰∏ÄÂ∫¶ÂÜçÁîü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
            }

            try {
                const res = await fetch(
                    `https://api.spotify.com/v1/me/player/play?device_id=${spotifyDeviceId}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${spotifyToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ uris: [uri] })
                    }
                );

                if (res.ok || res.status === 204) {
                    console.log('‚úÖ SpotifyÂÜçÁîüÊàêÂäü');
                    showStatus('‚úÖ Spotify„ÅßÂÜçÁîü‰∏≠', '#1DB954');
                } else {
                    const err = await res.json();
                    console.error('‚ùå SpotifyÂÜçÁîü„Ç®„É©„Éº:', err);
                    showStatus('‚ùå ÂÜçÁîü„Ç®„É©„Éº', '#f55');
                }
            } catch (e) {
                console.error('‚ùå SpotifyÂÜçÁîü„Ç®„É©„Éº:', e);
                showStatus('‚ùå ÂÜçÁîü„Ç®„É©„Éº', '#f55');
            }
        }

        // AudioÂÜçÁîüÔºàSoundCloud„ÄÅNinaÔºâ
        function playAudio(url) {
            currentAudio = new Audio(url);
            currentAudio.play().then(() => {
                console.log('‚úÖ AudioÂÜçÁîüÈñãÂßã');
                showStatus('‚úÖ ÂÜçÁîü‰∏≠', '#1DB954');
            }).catch(err => {
                console.error('‚ùå AudioÂÜçÁîü„Ç®„É©„Éº:', err);
                alert('ÂÜçÁîü„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü: ' + err.message);
            });
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
        function showStatus(msg, color) {
            const s = document.getElementById('status');
            s.innerHTML = `<div class="status" style="background: ${color}22; border: 1px solid ${color};">${msg}</div>`;
            setTimeout(() => s.innerHTML = '', 5000);
        }
    </script>
</body>
</html>
