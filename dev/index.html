<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onpa</title>
    <script src="https://cdn.webrtc.ecl.ntt.com/skyway-4.4.5.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #000; color: #fff; min-height: 100vh; }
        .container { max-width: 430px; width: 100%; margin: 0 auto; padding: 40px; }

```
    .logo { 
        font-size: 48px; 
        font-weight: 800; 
        text-align: center; 
        margin-bottom: 10px;
        background: linear-gradient(90deg, #ec4899, #6366f1, #8b5cf6, #a855f7, #feca57, #ff6b6b, #ec4899);
        background-size: 400% 100%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 30px rgba(236, 72, 153, 0.5))
                drop-shadow(0 0 60px rgba(99, 102, 241, 0.3))
                contrast(0.95) saturate(1.1);
        animation: logoGradientFlow 30s linear infinite;
        position: relative;
    }
    .logo::after {
        content: 'Onpa';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: inherit;
        background-clip: text;
        -webkit-background-clip: text;
        opacity: 0.15;
        filter: blur(1px);
        z-index: -1;
    }
    @keyframes logoGradientFlow {
        0% { background-position: 0% 50%; }
        100% { background-position: 400% 50%; }
    }
    
    .subtitle { text-align: center; font-size: 14px; color: #666; margin-bottom: 50px; }
    .avatar-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 40px; }
    .avatar-container { position: relative; margin-bottom: 15px; }
    .avatar-circle { 
        width: 120px; height: 120px; border-radius: 50%; cursor: pointer; 
        transition: all 0.3s; background-size: cover; background-position: center;
    }
    .avatar-circle:active { transform: scale(0.95); }
    
    .gradient-1 { background: radial-gradient(circle at 30% 20%, #667eea, transparent 50%), radial-gradient(circle at 70% 80%, #f093fb, transparent 50%), linear-gradient(135deg, #667eea, #764ba2); filter: drop-shadow(0 0 15px rgba(102, 126, 234, 0.6)); }
    .gradient-2 { background: radial-gradient(circle at 20% 70%, #f5576c, transparent 45%), radial-gradient(circle at 80% 30%, #ffd140, transparent 55%), linear-gradient(120deg, #f093fb, #f5576c); filter: drop-shadow(0 0 15px rgba(245, 87, 108, 0.6)); }
    .gradient-3 { background: radial-gradient(circle at 65% 15%, #00f2fe, transparent 50%), radial-gradient(circle at 25% 85%, #43e97b, transparent 50%), linear-gradient(140deg, #4facfe, #00f2fe); filter: drop-shadow(0 0 15px rgba(79, 172, 254, 0.6)); }
    .gradient-4 { background: radial-gradient(circle at 40% 75%, #38f9d7, transparent 48%), radial-gradient(circle at 75% 25%, #4facfe, transparent 52%), linear-gradient(155deg, #43e97b, #38f9d7); filter: drop-shadow(0 0 15px rgba(67, 233, 123, 0.6)); }
    .gradient-5 { background: radial-gradient(circle at 15% 35%, #fa709a, transparent 47%), radial-gradient(circle at 85% 65%, #30cfd0, transparent 53%), linear-gradient(125deg, #fa709a, #fee140); filter: drop-shadow(0 0 15px rgba(250, 112, 154, 0.6)); }
    .gradient-6 { background: radial-gradient(circle at 55% 25%, #30cfd0, transparent 44%), radial-gradient(circle at 35% 75%, #c471f5, transparent 56%), linear-gradient(110deg, #30cfd0, #330867); filter: drop-shadow(0 0 15px rgba(196, 113, 245, 0.6)); }
    .gradient-7 { background: radial-gradient(circle at 70% 60%, #fed6e3, transparent 49%), radial-gradient(circle at 30% 40%, #fbc2eb, transparent 51%), linear-gradient(145deg, #a8edea, #fed6e3); filter: drop-shadow(0 0 15px rgba(254, 214, 227, 0.6)); }
    .gradient-8 { background: radial-gradient(circle at 45% 80%, #fecfef, transparent 46%), radial-gradient(circle at 60% 20%, #ffc3a0, transparent 54%), linear-gradient(130deg, #ff9a9e, #fecfef); filter: drop-shadow(0 0 15px rgba(255, 154, 158, 0.6)); }
    
    .add-photo-btn { position: absolute; bottom: 5px; right: 5px; width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: 3px solid #000; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px rgba(99, 102, 241, 0.6); }
    .plus-icon { width: 20px; height: 20px; position: relative; }
    .plus-icon::before, .plus-icon::after { content: ''; position: absolute; background: white; border-radius: 2px; }
    .plus-icon::before { width: 16px; height: 3px; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .plus-icon::after { width: 3px; height: 16px; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    
    .avatar-hint { font-size: 12px; color: #666; text-align: center; }
    .input-group { margin-bottom: 25px; }
    .input-label { font-size: 11px; color: #666; margin-bottom: 10px; letter-spacing: 0.5px; font-weight: 500; }
    .input-container { display: flex; align-items: center; background: #0a0a0a; border: 2px solid #1a1a1a; border-radius: 14px; padding: 0 18px; transition: all 0.3s; }
    .input-container:focus-within { 
        border-color: #6366f1; 
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.3),
                    0 0 40px rgba(99, 102, 241, 0.1);
    }
    .input-prefix { color: #666; font-size: 20px; font-weight: 700; margin-right: 5px; }
    .input-field { flex: 1; padding: 16px 0; background: transparent; border: none; color: white; font-size: 16px; font-weight: 600; outline: none; }
    .input-field::placeholder { color: #333; }
    .btn { 
        width: 100%; padding: 16px; 
        background: linear-gradient(135deg, #6366f1, #ec4899); 
        border: none; border-radius: 14px; color: white; font-weight: 700; font-size: 16px; cursor: pointer; 
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.5),
                    0 0 40px rgba(236, 72, 153, 0.3);
    }
    .btn:active { transform: scale(0.98); }
    
    input[type="file"] { display: none; }
    .home-screen, .call-screen { display: none; }
    .home-screen.active, .call-screen.active { display: block; }
    
    .home-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .home-logo { 
        font-size: 32px; font-weight: 800;
        background: linear-gradient(90deg, #ec4899, #6366f1, #8b5cf6, #a855f7, #feca57, #ff6b6b, #ec4899);
        background-size: 400% 100%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 25px rgba(236, 72, 153, 0.5))
                drop-shadow(0 0 50px rgba(99, 102, 241, 0.3))
                contrast(0.95) saturate(1.1);
        animation: logoGradientFlow 30s linear infinite;
    }
    .user-avatar-small { 
        width: 50px; height: 50px; border-radius: 50%; cursor: pointer; 
        border: 2px solid #1a1a1a; transition: all 0.3s; background-size: cover; background-position: center; 
    }
    .user-avatar-small:hover { border-color: #6366f1; transform: scale(1.05); }
    
    .call-btn-section { text-align: center; margin: 60px 0; display: flex; justify-content: center; }
    .call-btn { 
        width: 140px; height: 140px; border-radius: 50%; 
        background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.3) 0%, transparent 50%), 
                    radial-gradient(circle at 50% 50%, #ec4899 0%, #6366f1 50%, #1e1b4b 100%);
        border: none;
        cursor: pointer; 
        box-shadow: 0 0 60px rgba(236, 72, 153, 0.4),
                    0 0 120px rgba(99, 102, 241, 0.2),
                    inset 0 2px 20px rgba(255, 255, 255, 0.15),
                    inset 0 -20px 40px rgba(0, 0, 0, 0.4);
        font-size: 60px; display: flex; align-items: center; justify-content: center; 
        position: relative; overflow: visible;
        animation: orbColorShift 30s ease-in-out infinite;
    }
    
    .call-btn::before {
        content: '';
        position: absolute;
        inset: -20px;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(236, 72, 153, 0.4), transparent 70%);
        filter: blur(25px);
        z-index: -1;
        animation: pulseGlow 3s ease-in-out infinite;
    }
    
    @keyframes orbColorShift {
        0% {
            background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.3), transparent 50%), 
                        radial-gradient(circle at 50% 50%, #ec4899 0%, #6366f1 50%, #1e1b4b 100%);
            box-shadow: 0 0 60px rgba(236, 72, 153, 0.4), 0 0 120px rgba(99, 102, 241, 0.2),
                        inset 0 2px 20px rgba(255, 255, 255, 0.15), inset 0 -20px 40px rgba(0, 0, 0, 0.4);
        }
        16.6% {
            background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.3), transparent 50%), 
                        radial-gradient(circle at 50% 50%, #6366f1 0%, #8b5cf6 50%, #1e1b4b 100%);
            box-shadow: 0 0 60px rgba(99, 102, 241, 0.5), 0 0 120px rgba(139, 92, 246, 0.3),
                        inset 0 2px 20px rgba(255, 255, 255, 0.15), inset 0 -20px 40px rgba(0, 0, 0, 0.4);
        }
        33.3% {
            background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.3), transparent 50%), 
                        radial-gradient(circle at 50% 50%, #8b5cf6 0%, #a855f7 50%, #1e1b4b 100%);
            box-shadow: 0 0 60px rgba(139, 92, 246, 0.5), 0 0 120px rgba(168, 85, 247, 0.3),
                        inset 0 2px 20px rgba(255, 255, 255, 0.15), inset 0 -20px 40px rgba(0, 0, 0, 0.4);
        }
        50% {
            background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.3), transparent 50%), 
                        radial-gradient(circle at 50% 50%, #a855f7 0%, #ec4899 50%, #1e1b4b 100%);
            box-shadow: 0 0 60px rgba(168, 85, 247, 0.5), 0 0 120px rgba(236, 72, 153, 0.3),
                        inset 0 2px 20px rgba(255, 255, 255, 0.15), inset 0 -20px 40px rgba(0, 0, 0, 0.4);
        }
        66.6% {
            background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.3), transparent 50%), 
                        radial-gradient(circle at 50% 50%, #feca57 0%, #ff6b6b 50%, #1e1b4b 100%);
            box-shadow: 0 0 60px rgba(254, 202, 87, 0.5), 0 0 120px rgba(255, 107, 107, 0.3),
                        inset 0 2px 20px rgba(255, 255, 255, 0.15), inset 0 -20px 40px rgba(0, 0, 0, 0.4);
        }
        83.3% {
            background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.3), transparent 50%), 
                        radial-gradient(circle at 50% 50%, #ff6b6b 0%, #ec4899 50%, #1e1b4b 100%);
            box-shadow: 0 0 60px rgba(255, 107, 107, 0.4), 0 0 120px rgba(236, 72, 153, 0.3),
                        inset 0 2px 20px rgba(255, 255, 255, 0.15), inset 0 -20px 40px rgba(0, 0, 0, 0.4);
        }
        100% {
            background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.3), transparent 50%), 
                        radial-gradient(circle at 50% 50%, #ec4899 0%, #6366f1 50%, #1e1b4b 100%);
            box-shadow: 0 0 60px rgba(236, 72, 153, 0.4), 0 0 120px rgba(99, 102, 241, 0.2),
                        inset 0 2px 20px rgba(255, 255, 255, 0.15), inset 0 -20px 40px rgba(0, 0, 0, 0.4);
        }
    }
    
    @keyframes pulseGlow {
        0%, 100% { opacity: 0.4; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.15); }
    }
    
    .call-btn:active { transform: scale(0.95); }
    
    .call-screen { min-height: 100vh; padding: 40px 20px; text-align: center; }
    .call-screen-logo { 
        font-size: 32px; font-weight: 800; margin-bottom: 40px;
        background: linear-gradient(90deg, #ec4899, #6366f1, #8b5cf6, #a855f7, #feca57, #ff6b6b, #ec4899);
        background-size: 400% 100%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 25px rgba(236, 72, 153, 0.5))
                drop-shadow(0 0 50px rgba(99, 102, 241, 0.3))
                contrast(0.95) saturate(1.1);
        animation: logoGradientFlow 30s linear infinite;
    }
    .call-status { font-size: 16px; color: #666; margin-bottom: 20px; }
    .call-timer { font-size: 64px; font-weight: 700; color: #fff; margin-bottom: 60px; }
    
    .participants-container { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 60px; position: relative; transition: gap 0.8s; }
    .participants-container.connected { gap: 0; }
    .participant { display: flex; flex-direction: column; align-items: center; }
    .call-avatar { 
        width: 120px; height: 120px; border-radius: 50%; 
        background-size: cover; background-position: center; 
        transition: all 0.3s; border: 4px solid transparent; 
    }
    .participants-container.connected .call-avatar { margin: 0 -20px; }
    .call-avatar.speaking { 
        animation: pulse 1.5s ease-in-out infinite;
        filter: drop-shadow(0 0 30px rgba(99, 102, 241, 0.8));
    }
    @keyframes pulse { 
        0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); } 
        50% { box-shadow: 0 0 0 20px rgba(99, 102, 241, 0); } 
    }
    .participant-name { font-size: 14px; color: #666; margin-top: 15px; font-weight: 600; }
    
    .connection-wave { position: absolute; left: 50%; transform: translateX(-50%); transition: opacity 0.3s; }
    .connection-wave.hidden { opacity: 0; }
    .wave-line { width: 80px; height: 4px; position: relative; }
    .wave-dot { 
        position: absolute; width: 10px; height: 10px; 
        background: linear-gradient(135deg, #6366f1, #ec4899); 
        border-radius: 50%; 
        animation: waveDot 2s ease-in-out infinite;
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.8);
    }
    .wave-dot:nth-child(1) { animation-delay: 0s; }
    .wave-dot:nth-child(2) { animation-delay: 0.2s; }
    .wave-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes waveDot { 
        0% { left: 0; transform: translateY(0); } 
        25% { transform: translateY(-12px); } 
        50% { left: 50%; transform: translateY(0); } 
        75% { transform: translateY(12px); } 
        100% { left: 100%; transform: translateY(0); } 
    }
    
    .call-actions { display: flex; justify-content: center; gap: 25px; margin-top: 40px; }
    .call-action-btn { 
        width: 65px; height: 65px; border-radius: 50%; border: none; cursor: pointer; font-size: 28px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }
    .call-action-btn:active { transform: scale(0.9); }
    .call-action-btn.mute { 
        background: linear-gradient(135deg, #4a5568, #2d3748);
        box-shadow: 0 0 15px rgba(74, 85, 104, 0.5);
    }
    .call-action-btn.end { 
        background: linear-gradient(135deg, #ef4444, #dc2626);
        box-shadow: 0 0 25px rgba(239, 68, 68, 0.7);
    }
</style>
```

</head>
<body>
    <div class="container">
        <div id="setupScreen">
            <div class="logo">Onpa</div>
            <div class="subtitle">Create your profile</div>
            <div class="avatar-section">
                <div class="avatar-container">
                    <div class="avatar-circle gradient-1" id="avatarCircle" onclick="cycleGradient()"></div>
                    <div class="add-photo-btn" onclick="document.getElementById('photoInput').click()"><div class="plus-icon"></div></div>
                    <input type="file" id="photoInput" accept="image/*" onchange="handlePhotoUpload(event)">
                </div>
                <div class="avatar-hint">Tap circle to change color</div>
            </div>
            <div class="input-group">
                <div class="input-label">Your Name</div>
                <div class="input-container"><input type="text" class="input-field" id="usernameInput" placeholder="display name" maxlength="30" style="padding-left:18px;"></div>
            </div>
            <div class="input-group">
                <div class="input-label">User iD</div>
                <div class="input-container"><span class="input-prefix">@</span><input type="text" class="input-field" id="userIdInput" placeholder="your_id" maxlength="20"></div>
            </div>
            <button class="btn" onclick="completeSetup()">Start</button>
        </div>

```
    <div class="home-screen" id="homeScreen">
        <div class="home-header">
            <div class="home-logo">Onpa</div>
            <div class="user-avatar-small" id="userAvatarSmall" onclick="editProfile()"></div>
        </div>
        <div class="call-btn-section">
            <button class="call-btn" onclick="startCall()">ðŸ“ž</button>
        </div>
        <div class="input-group">
            <div class="input-label">Call Friend</div>
            <div class="input-container"><span class="input-prefix">@</span><input type="text" class="input-field" id="friendIdInput" placeholder="friend_id" maxlength="20"></div>
        </div>
    </div>

    <div class="call-screen" id="callScreen">
        <div class="call-screen-logo">Onpa</div>
        <div class="call-status" id="callStatus">Calling...</div>
        <div class="call-timer" id="callTimer">00:00</div>
        <div class="participants-container" id="participantsContainer">
            <div class="participant">
                <div class="call-avatar" id="myCallAvatar"></div>
                <div class="participant-name" id="myCallName">You</div>
            </div>
            <div class="connection-wave" id="connectionWave">
                <div class="wave-line"><div class="wave-dot"></div><div class="wave-dot"></div><div class="wave-dot"></div></div>
            </div>
            <div class="participant">
                <div class="call-avatar gradient-3" id="friendCallAvatar"></div>
                <div class="participant-name" id="friendCallName">Friend</div>
            </div>
        </div>
        <div class="call-actions">
            <button class="call-action-btn mute" onclick="toggleMute()">ðŸŽ¤</button>
            <button class="call-action-btn end" onclick="endCall()">ðŸ“ž</button>
        </div>
    </div>
</div>

<script>
    const SKYWAY_API_KEY = '174e3781-3f39-45f1-bce4-9b474b93385e';
    
    let userId=null, username=null, userAvatar='gradient-1', userPhoto=null, currentGradientIndex=0;
    const gradients=['gradient-1','gradient-2','gradient-3','gradient-4','gradient-5','gradient-6','gradient-7','gradient-8'];
    let peer=null, localStream=null, currentCall=null, callDuration=0, callTimer=null, isMuted=false;
    let ringtone=null;

    function cycleGradient(){if(userPhoto)return;currentGradientIndex=(currentGradientIndex+1)%gradients.length;userAvatar=gradients[currentGradientIndex];document.getElementById('avatarCircle').className='avatar-circle '+userAvatar;}
    function handlePhotoUpload(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=function(e){userPhoto=e.target.result;const c=document.getElementById('avatarCircle');c.style.backgroundImage=`url(${userPhoto})`;c.className='avatar-circle';};r.readAsDataURL(f);}
    
    function completeSetup(){
        const id=document.getElementById('userIdInput').value.trim();
        const name=document.getElementById('usernameInput').value.trim();
        if(!id||id.length<3)return alert('User ID must be at least 3 characters');
        if(!name)return alert('Please enter your name');
        userId=id; username=name;
        localStorage.setItem('onpa_user_id',id);
        localStorage.setItem('onpa_username',name);
        localStorage.setItem('onpa_avatar',userAvatar);
        if(userPhoto)localStorage.setItem('onpa_photo',userPhoto);
        document.getElementById('setupScreen').style.display='none';
        document.getElementById('homeScreen').classList.add('active');
        updateHomeDisplay();
        initializePeer();
    }
    
    function updateHomeDisplay(){
        const as=document.getElementById('userAvatarSmall');
        const mca=document.getElementById('myCallAvatar');
        if(userPhoto){
            as.style.backgroundImage=`url(${userPhoto})`; as.className='user-avatar-small';
            mca.style.backgroundImage=`url(${userPhoto})`; mca.className='call-avatar';
        }else{
            as.className='user-avatar-small '+userAvatar;
            mca.className='call-avatar '+userAvatar;
        }
        document.getElementById('myCallName').textContent=username;
    }
    
    async function initializePeer(){
        try {
            localStream = await navigator.mediaDevices.getUserMedia({audio: true, video: false});
            
            peer = new Peer(userId, { key: SKYWAY_API_KEY, debug: 3 });

            peer.on('open', id => console.log('My ID:', id));

            peer.on('call', call => {
                console.log('Incoming call from:', call.remoteId);
                
                // Play ringtone
                if(ringtone) {
                    ringtone.play().catch(e => console.log('Ringtone play failed:', e));
                }
                
                call.answer(localStream);
                setupCallEvents(call);
            });

            peer.on('error', err => {
                console.error('Peer Error:', err);
                if(err.type === 'unavailable-id') alert('IDãŒæ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™');
            });
        } catch(e) {
            alert('ãƒžã‚¤ã‚¯ãŒä½¿ãˆã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    }
    
    function startCall(){
        const friendId = document.getElementById('friendIdInput').value.trim();
        if(!friendId) return alert('ç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        if(!peer) return alert('æº–å‚™ä¸­ã§ã™...');

        console.log('Calling:', friendId);
        const call = peer.call(friendId, localStream);
        setupCallEvents(call);
    }

    function setupCallEvents(call) {
        currentCall = call;
        
        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('callScreen').classList.add('active');
        document.getElementById('friendCallName').textContent = '@' + call.remoteId;

        call.on('stream', stream => {
            console.log('Received remote stream');
            playRemoteStream(stream);
            onCallConnected();
        });

        call.on('close', () => endCall());
    }
    
    function onCallConnected(){
        // Stop ringtone
        if(ringtone) {
            ringtone.pause();
            ringtone.currentTime = 0;
        }
        
        document.getElementById('callStatus').textContent='Connected';
        document.getElementById('connectionWave').classList.add('hidden');
        document.getElementById('participantsContainer').classList.add('connected');
        if(callTimer) clearInterval(callTimer);
        callDuration=0;
        callTimer=setInterval(()=>{
            callDuration++;
            const m=Math.floor(callDuration/60);
            const s=callDuration%60;
            document.getElementById('callTimer').textContent=`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        },1000);
        
        document.getElementById('myCallAvatar').classList.add('speaking');
        setTimeout(() => document.getElementById('friendCallAvatar').classList.add('speaking'), 1000);
    }
    
    function endCall(){
        // Stop ringtone if still playing
        if(ringtone) {
            ringtone.pause();
            ringtone.currentTime = 0;
        }
        
        if(currentCall) { currentCall.close(); currentCall = null; }
        if(callTimer) { clearInterval(callTimer); callTimer = null; }
        document.getElementById('callScreen').classList.remove('active');
        document.getElementById('homeScreen').classList.add('active');
        document.getElementById('connectionWave').classList.remove('hidden');
        document.getElementById('participantsContainer').classList.remove('connected');
        const audio = document.getElementById('remoteAudio');
        if(audio) audio.remove();
    }
    
    function toggleMute(){
        if(localStream){
            const at=localStream.getAudioTracks()[0];
            at.enabled=!at.enabled;
            isMuted=!at.enabled;
            event.target.textContent=isMuted?'ðŸ”‡':'ðŸŽ¤';
        }
    }
    
    function playRemoteStream(stream){
        let a = document.getElementById('remoteAudio');
        if(!a) {
            a = document.createElement('audio');
            a.id = 'remoteAudio';
            a.autoplay = true;
            a.playsInline = true;
            document.body.appendChild(a);
        }
        a.srcObject = stream;
        a.play().catch(e => console.error("Audio Play Error:", e));
    }
    
    function editProfile(){
        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('setupScreen').style.display='block';
    }
    
    window.onload=function(){
        // Load ringtone
        ringtone = new Audio();
        ringtone.src = 'ringtone.wav';
        ringtone.loop = true;
        
        const si=localStorage.getItem('onpa_user_id');
        const sn=localStorage.getItem('onpa_username');
        const sa=localStorage.getItem('onpa_avatar');
        const sp=localStorage.getItem('onpa_photo');
        if(si&&sn){
            userId=si; username=sn; userAvatar=sa||'gradient-1'; userPhoto=sp;
            currentGradientIndex=gradients.indexOf(userAvatar);
            document.getElementById('setupScreen').style.display='none';
            document.getElementById('homeScreen').classList.add('active');
            updateHomeDisplay();
            initializePeer();
        }
    };
</script>
```

</body>
</html>