<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onpa - éŸ³æ¥½ã‚·ã‚§ã‚¢é€šè©±ã‚¢ãƒ—ãƒª</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #000;
        color: #fff;
    }

    .container {
        max-width: 430px;
        margin: 0 auto;
        padding: 20px;
    }

    .logo {
        font-size: 32px;
        font-weight: 800;
        background: linear-gradient(135deg, #ff3366, #0096ff, #00ffc8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 20px;
    }

    .spotify-login {
        background: #1DB954;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 700;
        cursor: pointer;
        width: 100%;
        margin-bottom: 20px;
    }

    .search-bar {
        width: 100%;
        padding: 14px;
        border-radius: 25px;
        border: 1px solid #333;
        background: #222;
        color: white;
        margin-bottom: 15px;
    }

    .search-result-item {
        background: #222;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .result-artwork {
        width: 50px;
        height: 50px;
        border-radius: 6px;
    }

    .result-info {
        flex: 1;
    }

    .result-track {
        font-weight: 600;
        margin-bottom: 3px;
    }

    .result-artist {
        font-size: 12px;
        color: #888;
    }

    .result-play-btn {
        background: #1DB954;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
    }

    .status {
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 15px;
        text-align: center;
    }

    .device-info {
        background: #222;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 12px;
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="logo">Onpa</div>

```
    <button class="spotify-login" id="loginBtn" onclick="loginSpotify()">
        ğŸµ Spotifyã§ãƒ­ã‚°ã‚¤ãƒ³
    </button>

    <div id="status"></div>

    <div id="player" style="display: none;">
        <div class="device-info" id="deviceInfo">ãƒ‡ãƒã‚¤ã‚¹: èª­ã¿è¾¼ã¿ä¸­...</div>
        
        <input 
            type="text" 
            id="searchInput" 
            class="search-bar" 
            placeholder="æ›²ã‚’æ¤œç´¢..."
            onkeypress="if(event.key==='Enter') search()"
        >
        <div id="results"></div>
    </div>
</div>

<script>
    // ========================================
    // ğŸ”‘ è¨­å®š
    // ========================================
    const CLIENT_ID = '1ff4e8ebb2f94fb5a20149d697df21fc';
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    
    console.log('Redirect URI:', REDIRECT_URI);
    // ========================================

    let token = null;
    let deviceId = null;

    // åˆæœŸåŒ–
    window.onload = () => {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        token = params.get('access_token');

        if (token) {
            window.history.replaceState({}, '', window.location.pathname);
            document.getElementById('loginBtn').textContent = 'âœ“ ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿';
            document.getElementById('loginBtn').disabled = true;
            document.getElementById('player').style.display = 'block';
            showStatus('âœ… Spotifyã«æ¥ç¶šã—ã¾ã—ãŸ', '#1DB954');
            getDevices();
        }
    };

    // Spotifyãƒ­ã‚°ã‚¤ãƒ³ï¼ˆGeminiä¿®æ­£ç‰ˆï¼‰
    function loginSpotify() {
        const scopes = 'user-read-playback-state user-modify-playback-state streaming user-read-private user-read-email';
        
        // URLSearchParamsã§æ­£ã—ãæ§‹ç¯‰
        const authUrl = 'https://accounts.spotify.com/authorize';
        const queryParams = new URLSearchParams({
            client_id: CLIENT_ID,
            response_type: 'token',
            redirect_uri: REDIRECT_URI,
            scope: scopes,
            show_dialog: 'true'
        });

        console.log('Auth URL:', `${authUrl}?${queryParams.toString()}`);
        window.location.href = `${authUrl}?${queryParams.toString()}`;
    }

    // ãƒ‡ãƒã‚¤ã‚¹å–å¾—
    async function getDevices() {
        try {
            const res = await fetch('https://api.spotify.com/v1/me/player/devices', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            if (data.devices?.length > 0) {
                const active = data.devices.find(d => d.is_active) || data.devices[0];
                deviceId = active.id;
                document.getElementById('deviceInfo').textContent = 
                    `ãƒ‡ãƒã‚¤ã‚¹: ${active.name} (${active.type})`;
                console.log('Device selected:', active);
            } else {
                document.getElementById('deviceInfo').innerHTML = 
                    'âš ï¸ ãƒ‡ãƒã‚¤ã‚¹ãªã— - Spotifyã‚¢ãƒ—ãƒªã§ä½•ã‹å†ç”Ÿã—ã¦ãã ã•ã„';
            }
        } catch (e) {
            console.error('Device error:', e);
        }
    }

    // æ¤œç´¢
    async function search() {
        const q = document.getElementById('searchInput').value;
        if (!q) return;

        try {
            const res = await fetch(
                `https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track&market=JP&limit=10`,
                { headers: { 'Authorization': `Bearer ${token}` } }
            );
            const data = await res.json();
            displayResults(data.tracks.items);
        } catch (e) {
            console.error('Search error:', e);
        }
    }

    // çµæœè¡¨ç¤º
    function displayResults(tracks) {
        const div = document.getElementById('results');
        div.innerHTML = '';

        if (!tracks || tracks.length === 0) {
            div.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">çµæœãªã—</div>';
            return;
        }

        tracks.forEach(t => {
            const trackDiv = document.createElement('div');
            trackDiv.className = 'search-result-item';
            trackDiv.innerHTML = `
                <img src="${t.album.images[0]?.url || ''}" class="result-artwork">
                <div class="result-info">
                    <div class="result-track">${t.name}</div>
                    <div class="result-artist">${t.artists[0].name}</div>
                </div>
                <button class="result-play-btn" onclick="play('${t.uri}')">â–¶ï¸</button>
            `;
            div.appendChild(trackDiv);
        });
    }

    // å†ç”Ÿ
    async function play(uri) {
        if (!deviceId) {
            await getDevices();
            if (!deviceId) {
                alert('ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\n\nSpotifyã‚¢ãƒ—ãƒªã§æ›²ã‚’ä¸€åº¦å†ç”Ÿã—ã¦ãã ã•ã„ã€‚');
                return;
            }
        }

        try {
            const res = await fetch(
                `https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ uris: [uri] })
                }
            );

            if (res.ok || res.status === 204) {
                showStatus('âœ… å†ç”Ÿä¸­', '#1DB954');
            } else if (res.status === 404) {
                alert('ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Spotifyã‚¢ãƒ—ãƒªã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                deviceId = null;
                await getDevices();
            } else {
                const err = await res.json();
                console.error('Play error:', err);
                showStatus('âŒ ã‚¨ãƒ©ãƒ¼: ' + (err.error?.message || 'Unknown'), '#f55');
            }
        } catch (e) {
            console.error('Play error:', e);
            showStatus('âŒ å†ç”Ÿã‚¨ãƒ©ãƒ¼', '#f55');
        }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    function showStatus(msg, color) {
        const s = document.getElementById('status');
        s.innerHTML = `<div class="status" style="background: ${color}22; border: 1px solid ${color};">${msg}</div>`;
        setTimeout(() => s.innerHTML = '', 5000);
    }
</script>
```

</body>
</html>
